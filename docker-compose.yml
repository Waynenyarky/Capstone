
services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: capstone-mongodb
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: capstone_project
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ganache (Blockchain)
  ganache:
    image: trufflesuite/ganache:latest
    container_name: capstone-ganache
    ports:
      - "7545:8545"
    command:
      - "--mnemonic"
      - "test test test test test test test test test test test junk"
      - "--host"
      - "0.0.0.0"
      - "--port"
      - "8545"
      - "--accounts"
      - "10"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('net').createConnection(8545,'127.0.0.1').on('connect',()=>process.exit(0)).on('error',()=>process.exit(1))\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # IPFS Node
  ipfs:
    image: ipfs/kubo:latest
    container_name: capstone-ipfs
    ports:
      - "4001:4001"   # Swarm
      - "5001:5001"   # API
      - "8080:8080"   # Gateway
    volumes:
      - ipfs_data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
    healthcheck:
      test: ["CMD", "ipfs", "version"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Wait for services to be ready
  wait-for-services:
    image: alpine:latest
    depends_on:
      mongodb:
        condition: service_healthy
      ganache:
        condition: service_healthy
      ipfs:
        condition: service_healthy
    command: >
      sh -c "
        echo 'Waiting for all services to be ready...' &&
        apk add --no-cache netcat-openbsd &&
        timeout 60 sh -c 'until nc -z mongodb 27017 && nc -z ganache 8545 && nc -z ipfs 5001; do sleep 1; done' &&
        echo 'All services are ready!'
      "

  # Deploy contracts (runs once)
  deploy-contracts:
    build:
      context: ./blockchain
      dockerfile: Dockerfile
    container_name: capstone-deploy-contracts
    depends_on:
      wait-for-services:
        condition: service_completed_successfully
      ganache:
        condition: service_started
    environment:
      - GANACHE_HOST=ganache
      - GANACHE_PORT=8545
      - GANACHE_RPC_URL=http://ganache:8545
      - DEPLOYER_PRIVATE_KEY=${DEPLOYER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    volumes:
      - contract_addresses:/app/build/contracts
      - ./.env:/env/.env
    command: >
      sh -c "
        echo 'Waiting for Ganache...' &&
        sleep 5 &&
        npm run compile &&
        npm run migrate:ganache &&
        echo 'Contracts deployed!' &&
        node extract-addresses.js &&
        node write-env.js /env/.env
      "

  # Auth Service
  auth-service:
    build:
      context: ./backend/services/auth-service
      dockerfile: Dockerfile
    container_name: capstone-auth-service
    ports:
      - "3001:3001"
    depends_on:
      mongodb:
        condition: service_healthy
      ipfs:
        condition: service_healthy
      deploy-contracts:
        condition: service_completed_successfully
    env_file: .env
    environment:
      - MONGO_URI=mongodb://mongodb:27017/capstone_project
      - IPFS_API_URL=${DOCKER_IPFS_API_URL}
      - IPFS_GATEWAY_URL=${DOCKER_IPFS_GATEWAY_URL}
      - AUDIT_SERVICE_URL=${DOCKER_AUDIT_SERVICE_URL}
      - SEED_DEV=true
      - SEED_TEMP_PASSWORD=${SEED_TEMP_PASSWORD:-TempPass123!}
    volumes:
      - contract_addresses:/app/contract-addresses:ro
    restart: unless-stopped

  # Business Service
  business-service:
    build:
      context: ./backend
      dockerfile: services/business-service/Dockerfile
    container_name: capstone-business-service
    ports:
      - "3002:3002"
    depends_on:
      - mongodb
      - ipfs
      - deploy-contracts
    env_file: .env
    environment:
      - MONGO_URI=mongodb://mongodb:27017/capstone_project
      - IPFS_API_URL=${DOCKER_IPFS_API_URL}
      - IPFS_GATEWAY_URL=${DOCKER_IPFS_GATEWAY_URL}
      - AUDIT_SERVICE_URL=${DOCKER_AUDIT_SERVICE_URL}
      - AUTH_SERVICE_URL=${DOCKER_AUTH_SERVICE_URL}
    volumes:
      - contract_addresses:/app/contract-addresses:ro
    restart: unless-stopped

  # Admin Service
  admin-service:
    build:
      context: ./backend
      dockerfile: services/admin-service/Dockerfile
    container_name: capstone-admin-service
    ports:
      - "3003:3003"
    depends_on:
      mongodb:
        condition: service_healthy
      deploy-contracts:
        condition: service_completed_successfully
    env_file: .env
    environment:
      - MONGO_URI=mongodb://mongodb:27017/capstone_project
      - AUTH_SERVICE_URL=${DOCKER_AUTH_SERVICE_URL}
      - AUDIT_SERVICE_URL=${DOCKER_AUDIT_SERVICE_URL}
      - BUSINESS_SERVICE_URL=${DOCKER_BUSINESS_SERVICE_URL}
      - SEED_FORM_DEFINITIONS=true
    volumes:
      - contract_addresses:/app/contract-addresses:ro
    restart: unless-stopped

  # Audit Service
  audit-service:
    build:
      context: ./backend/services/audit-service
      dockerfile: Dockerfile
    container_name: capstone-audit-service
    ports:
      - "3004:3004"
    depends_on:
      - mongodb
      - ganache
      - deploy-contracts
    env_file: .env
    environment:
      - MONGO_URI=mongodb://mongodb:27017/capstone_project
      - GANACHE_RPC_URL=http://ganache:8545
      - CONTRACT_ABI_PATH=/app/contract-addresses
    volumes:
      - contract_addresses:/app/contract-addresses:ro
    restart: unless-stopped

  # Dozzle - Live log viewer for all containers (open in browser for POST/GET/fetch logs)
  dozzle:
    image: amir20/dozzle:latest
    container_name: capstone-dozzle
    ports:
      - "9999:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped

  # AI Service (OCR + ID Verification) â€” logs visible in Dozzle under group "AI"
  ai-service:
    build:
      context: ./backend/services/ai-service
      dockerfile: Dockerfile
    container_name: capstone-ai-service
    labels:
      - "dev.dozzle.group=AI"
    ports:
      - "3005:3005"
    depends_on:
      - mongodb
    env_file: .env
    environment:
      - AI_SERVICE_PORT=3005
      - AI_SERVICE_ID_VERIFICATION_MODEL_PATH=/app/models/model_v1.h5
      - AI_SERVICE_CORS_ORIGINS=${CORS_ORIGIN:-http://localhost:5173},http://business-service:3002,http://auth-service:3001
    volumes:
      - ./ai/models/id_verification:/app/models:ro
      - easyocr_cache:/root/.EasyOCR
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:3005/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  mongodb_data:
  ipfs_data:
  contract_addresses:
  easyocr_cache:
